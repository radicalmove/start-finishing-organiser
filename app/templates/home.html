{% extends "base.html" %}
{% block content %}
  {% if form_success %}
    <div class="toast success">{{ form_success }}</div>
  {% endif %}

  <section class="main-shell">
    <div class="left-col">
      <div class="panel inbox-panel">
        <h3>Inbox</h3>
        <div class="muted">New/parked items. Process when you have a moment.</div>
        <div class="list" style="margin-top: 10px;">
          {% for t in inbox_tasks %}
            <div class="list-item">
              <div>{{ t.verb_noun }}</div>
              <div class="muted">{{ t.when_bucket.value|title }}</div>
              <div class="task-meta">
                {% if t.project %}<span class="pill">{{ t.project.title }}</span>{% endif %}
              </div>
            </div>
          {% else %}
            <div class="muted">Inbox clear.</div>
          {% endfor %}
        </div>
        <div class="cta-row">
          <a class="btn pink" href="/capture">Quick capture</a>
          <a class="btn ghost" href="/capture/wizard">Guided capture</a>
          <a class="btn ghost" href="/waiting">Waiting On / OPP</a>
        </div>
      </div>
    </div>
    <div class="right-col">
      <div class="right-top">
        <div class="panel calendar-panel">
          <div class="panel-title-row">
            <h3>Today calendar</h3>
            <div class="panel-actions">
              <a class="btn pink btn-sm" href="/blocks#add-block">Add time block</a>
              <a class="btn ghost blue btn-sm" href="/calendar/week">Week view</a>
            </div>
          </div>
          <div class="muted calendar-meta">
            Cozi: {{ cozi_event_count }} today · Updated {{ cozi_last_updated or '—' }}
          </div>
          {% if cozi_error %}
            <div class="calendar-error">{{ cozi_error }}</div>
          {% endif %}
          <div class="day-calendar" style="--calendar-hours: {{ calendar_hours }}; --calendar-hour-height: {{ calendar_hour_height }}px;">
            <div class="day-calendar-scroll">
              <div class="hours">
                  {% for hr in range(calendar_start_hour, calendar_end_hour) %}
                    <div class="hour-mark">{{ hr if hr <= 12 else hr-12 }} {{ 'AM' if hr < 12 else 'PM' }}</div>
                  {% endfor %}
                </div>
              <div class="events">
                <div class="timeline-align"></div>
                {% if now_position is not none %}
                  <div
                    class="now-line"
                    data-now-line
                    data-start-minutes="{{ day_start_minutes }}"
                    data-total-minutes="{{ day_total_minutes }}"
                    style="top: {{ "%.4f"|format(now_position) }}%;"
                  >
                    <span class="now-line-label">{{ now_label }}</span>
                  </div>
                {% endif %}
                {% for ev in calendar_events %}
                  {% set label_prefix = ev.label_prefix %}
                  {% set label_suffix = ev.label_suffix %}
                  {% if not label_prefix and ev.type == "external" and ":" in ev.label %}
                    {% set parts = ev.label.split(":", 1) %}
                    {% set label_prefix = parts[0] ~ ":" %}
                    {% set label_suffix = parts[1] | trim %}
                  {% endif %}
                  <div class="event-block {{ ev.type }}{% if ev.extra_class %} {{ ev.extra_class }}{% endif %}" style="top: {{ ev.top }}%; height: {{ ev.height }}%;">
                    <div class="event-time">{{ ev.start_display }}{% if ev.end_display %} – {{ ev.end_display }}{% endif %}</div>
                    {% if ev.type == "external" and label_prefix %}
                      <div class="event-label event-label--split">
                        <span class="event-label-strong">{{ label_prefix }}</span>
                        {% if label_suffix %}
                          <span class="event-label-body"> {{ label_suffix }}</span>
                        {% endif %}
                      </div>
                    {% else %}
                      <div class="event-label">{{ ev.label }}</div>
                    {% endif %}
                    {% if ev.block_id %}
                      <div class="event-edit">
                        <button type="button" class="event-edit-toggle">Edit</button>
                        <form method="post" action="/blocks/update" class="event-edit-form hidden">
                          <input type="hidden" name="csrf_token" value="{{ csrf_token(request) }}">
                          <input type="hidden" name="block_id" value="{{ ev.block_id }}">
                          <input type="text" name="title" value="{{ ev.title or ev.label }}" placeholder="Block title">
                          <button class="event-edit-save" type="submit">Save</button>
                        </form>
                      </div>
                    {% endif %}
                    {% if ev.project %}<div class="event-project">{{ ev.project }}</div>{% endif %}
                  </div>
              {% endfor %}
            </div>
            </div>
          </div>
        </div>
        <div class="right-stack">
          <div class="panel">
            <h3>Now</h3>
            {% if current_block %}
              <div class="list-item">
                {% if current_block.title %}
                  <div>{{ current_block.title }}</div>
                  <div class="muted">
                    {{ current_block.block_type.value|title }} • {{ current_block.start_time }} - {{ current_block.end_time }}
                  </div>
                {% else %}
                  <div>{{ current_block.block_type.value|title }} block</div>
                  <div class="muted">
                    {{ current_block.start_time }} - {{ current_block.end_time }}
                  </div>
                {% endif %}
                {% if current_block.project %}
                  <div class="task-meta"><span class="pill">{{ current_block.project.title }}</span></div>
                {% endif %}
              </div>
            {% else %}
              <div class="muted">No block active right now. Choose your One Thing and a Frog.</div>
            {% endif %}
            <div class="cta-row">
              <a class="btn ghost blue" href="/ritual/morning">Morning check-in</a>
              <a class="btn ghost blue" href="/ritual/midday">Midday reset</a>
              <a class="btn ghost blue" href="/ritual/evening">Evening check-out</a>
            </div>
          </div>
          <div class="panel today-tasks-panel">
            <h3>Today tasks</h3>
            <div class="muted">Focus/Frog tasks for Today.</div>
            <div class="list" style="margin-top: 12px;">
              {% for t in today_tasks %}
                <div class="list-item">
                  <div>{{ t.verb_noun }}</div>
                  <div class="muted">{{ t.description or "No notes yet." }}</div>
                  <div class="task-meta">
                    {% if t.block_type %}<span class="pill">{{ t.block_type.value }}</span>{% endif %}
                    {% if t.frog %}<span class="pill pill--warn">Frog</span>{% endif %}
                    {% if t.alignment %}<span class="pill">{{ t.alignment.value }}</span>{% endif %}
                  </div>
                </div>
              {% else %}
                <div class="muted">No tasks in Today bucket. Add via Capture.</div>
              {% endfor %}
            </div>
            <div class="cta-row">
              <a class="btn pink" href="/capture">Quick capture</a>
              <a class="btn ghost" href="/capture/wizard">Guided capture</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
{% endblock %}
