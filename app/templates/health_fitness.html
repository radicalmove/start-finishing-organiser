{% extends "base.html" %}

{% block content %}
  <section class="health-shell">
    {% set hero_title = "Fitness + endurance" %}
    {% set hero_subtitle = "Build stamina with consistent movement and recovery signals." %}
    {% set hero_tag = "Cardio + capacity" %}
    {% include "partials/health_nav.html" %}

    {% if form_error %}
      <div class="panel health-alert">{{ form_error }}</div>
    {% endif %}

    <div class="health-dashboard-grid">
      <div class="panel">
        <div class="panel-title-row">
          <h3>Log fitness</h3>
          <div class="panel-actions">
            <span class="pill">Movement volume</span>
          </div>
        </div>
        <form class="form" method="post" action="/health/entry">
          <input type="hidden" name="csrf_token" value="{{ csrf_token(request) }}">
          <input type="hidden" name="return_to" value="/health/fitness">
          <label class="field">
            Metric
            <select name="metric_id" required>
              {% for metric in entry_metrics %}
                <option value="{{ metric.id }}">{{ metric.name }}</option>
              {% endfor %}
            </select>
          </label>
          <div class="field two">
            <label>
              Value
              <input type="text" name="value" placeholder="Enter a number" required>
            </label>
            <label>
              Date
              <input type="date" name="entry_date">
            </label>
          </div>
          <label class="field">
            Notes
            <input type="text" name="notes" placeholder="Workout type or intensity">
          </label>
          <div class="cta-row cta-row--end">
            <button class="btn pink btn-sm" type="submit">Save fitness</button>
          </div>
        </form>
      </div>

      <div class="panel">
        <div class="panel-title-row">
          <h3>Cardio guidance</h3>
          <div class="panel-actions">
            <span class="pill">Evidence-based</span>
          </div>
        </div>
        <div class="health-guidance-list">
          <div class="health-guidance-item">
            <strong>Weekly volume:</strong> 150-300 minutes moderate or 75-150 vigorous.
          </div>
          <div class="health-guidance-item">
            <strong>Zone 2 base:</strong> Stack easy sessions to build aerobic capacity.
          </div>
          <div class="health-guidance-item">
            <strong>Intensity balance:</strong> 80% easy, 20% hard keeps recovery steady.
          </div>
          <div class="health-guidance-item">
            <strong>Recovery signals:</strong> Watch resting HR and sleep quality as load indicators.
          </div>
        </div>
        <div class="note">Adjust training load if fatigue or injury risk rises.</div>
      </div>
    </div>

    <div class="panel">
      <div class="panel-title-row">
        <h3>Fitness trends</h3>
        <div class="panel-actions">
          <span class="pill">Last 30 entries</span>
        </div>
      </div>
      <div class="health-chart-grid">
        {% for metric in metrics %}
          {% set latest = metric_latest.get(metric.id) %}
          {% set stat = metric_stats.get(metric.id) %}
          <div class="health-metric-card">
            <div class="health-metric-header">
              <div>
                <div class="health-metric-title">{{ metric.name }}</div>
                <div class="health-metric-subtitle">{{ metric.description or "Track your workload." }}</div>
              </div>
              <div class="health-metric-latest">
                {% if latest %}
                  {{ latest.value }}{% if metric.unit %} {{ metric.unit }}{% endif %}
                {% else %}
                  --
                {% endif %}
              </div>
            </div>
            <div class="health-chart" data-health-chart data-metric-id="{{ metric.id }}">
              <canvas></canvas>
              <div class="health-chart-empty">Add a few entries to see the trend.</div>
            </div>
            <div class="health-metric-meta">
              <span>7-day avg: {% if stat and stat.avg_7d is not none %}{{ stat.avg_7d|round(2) }}{% else %}--{% endif %}</span>
              <span>Trend: {% if stat and stat.trend is not none %}{{ stat.trend|round(2) }}{% else %}--{% endif %}</span>
            </div>
          </div>
        {% else %}
          <div class="muted">No fitness metrics yet. Add a custom metric from the dashboard.</div>
        {% endfor %}
      </div>
    </div>

    <div class="panel">
      <div class="panel-title-row">
        <h3>Recent entries</h3>
        <div class="panel-actions">
          <span class="pill">Latest log</span>
        </div>
      </div>
      <div class="health-entry-list">
        {% for entry in recent_entries %}
          <div class="health-entry-row">
            <div>
              <div class="health-entry-title">{{ entry.metric.name }}</div>
              <div class="health-entry-meta">{{ entry.entry_date }}{% if entry.notes %} Â· {{ entry.notes }}{% endif %}</div>
            </div>
            <div class="health-entry-value">
              {{ entry.value }}{% if entry.metric.unit %} {{ entry.metric.unit }}{% endif %}
            </div>
          </div>
        {% else %}
          <div class="muted">No fitness entries logged yet.</div>
        {% endfor %}
      </div>
    </div>
  </section>

  <script type="application/json" id="health-series">{{ health_series_json | safe }}</script>
{% endblock %}
